---
- name: Account Management
  hosts: all
  tasks:

  ######################### Default users for all linux users #########################
    - name: Add Internal user {{ item.name }} with a bash shell, appending the group {{ item.groups }}
      become: yes
      ansible.builtin.user:
        name: "{{ item.name }}"
        shell: /bin/bash
        password: "{{ item.password | password_hash('sha512')}}"
        update_password: "on_create"
        uid: "{{ item.uid }}"
        groups: "{{ item.groups }}"
        generate_ssh_key: yes
        ssh_key_bits: 4096
        ssh_key_file: .ssh/id_rsa
        append: yes
      loop:
        - { name: 'storm', groups: 'admin,dev', uid: 1005, password: 'Admin123456' } # Add a user with username storm part of the admin and dev groups with uid 1005
        - { name: 'stormey', groups: 'admin,qa', uid: 1006, password: 'Admin123456' }
      when: "'linux' in group_names"

  ######################### Master Users #########################
    - name: Add Internal user {{ item.name }} with a bash shell, appending the group {{ item.groups }}
      become: yes
      ansible.builtin.user:
        name: "{{ item.name }}"
        shell: /bin/bash
        password: "{{ item.password | password_hash('sha512')}}"
        update_password: "on_create"
        uid: "{{ item.uid }}"
        groups: "{{ item.groups }}"
        generate_ssh_key: yes
        ssh_key_bits: 4096
        ssh_key_file: .ssh/id_rsa
        append: yes
      loop:
        - { name: 'master-user-01', groups: 'admin,dev', uid: 1010, password: 'Admin123456' }
      when: 
        - "'master' in group_names"
        - "'linux' in group_names"

  ######################### Nodes Users #########################
    - name: Add Internal user {{ item.name }} with a bash shell, appending the group {{ item.groups }}
      become: yes
      ansible.builtin.user:
        name: "{{ item.name }}"
        shell: /bin/bash
        password: "{{ item.password | password_hash('sha512')}}"
        update_password: "on_create"
        uid: "{{ item.uid }}"
        groups: "{{ item.groups }}"
        generate_ssh_key: yes
        ssh_key_bits: 4096
        ssh_key_file: .ssh/id_rsa
        append: yes
      loop:
        - { name: 'nodes-user-01', groups: 'admin,dev', uid: 1020, password: 'Admin123456' }
      when: 
        - "'nodes' in group_names"
        - "'linux' in group_names"

  ######################### Remove Users #########################
    - name: Remove User {{ item.name }}
      become: yes
      ansible.builtin.user:
        name: "{{ item.name }}"
        state: absent
        remove: yes
      loop:
        - { name: '' }
      ignore_errors: True
      when: "'linux' in group_names" 
        